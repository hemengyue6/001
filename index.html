<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>åº“å­˜æ§åˆ¶åŸç†æµ‹è¯•å®è®­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <style>
        :root { --accent-blue: #3b82f6; --accent-green: #10b981; --accent-red: #ef4444; }
        body { background: #020617; color: #f8fafc; overflow: hidden; font-family: 'PingFang SC', sans-serif; }
        
        /* ç§‘æŠ€æ„ŸèƒŒæ™¯ç½‘æ ¼ */
        #tech-bg {
            position: fixed; inset: 0;
            background-image: linear-gradient(to right, rgba(59, 130, 246, 0.05) 1px, transparent 1px),
                              linear-gradient(to bottom, rgba(59, 130, 246, 0.05) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at center, black, transparent 80%);
            z-index: 0;
        }

        #video-preview { position: fixed; bottom: 20px; right: 20px; width: 160px; border-radius: 16px; border: 2px solid rgba(59, 130, 246, 0.3); transform: scaleX(-1); z-index: 100; box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }
        
        .glass { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        
        /* å†³ç­–èƒ½é‡åœº */
        #bg-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 1; transition: 0.5s cubic-bezier(0.4, 0, 0.2, 1); opacity: 0.3; }
        
        #particle-canvas { position: fixed; inset: 0; pointer-events: none; z-index: 50; }

        .btn-glow:hover { box-shadow: 0 0 20px rgba(59, 130, 246, 0.4); transform: translateY(-2px); }
        
        /* è¿›åº¦æ¡åŠ¨ç”» */
        .indicator-bar { position: absolute; bottom: 0; left: 0; height: 6px; transition: width 0.1s; border-radius: 0 0 2rem 2rem; filter: drop-shadow(0 0 8px currentColor); }

        #dify-chatbot-bubble-button { background-color: var(--accent-blue) !important; z-index: 1000 !important; border: 2px solid rgba(255,255,255,0.1) !important; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen">

    <div id="tech-bg"></div>
    <div id="bg-overlay"></div>
    <canvas id="particle-canvas"></canvas>
    <video id="video-preview" autoplay playsinline></video>

    <div id="start-screen" class="relative z-50 text-center glass p-10 rounded-[2.5rem] max-w-xl">
        <div class="inline-block p-4 rounded-3xl bg-blue-500/10 mb-6 border border-blue-500/20 shadow-inner">
            <span class="text-5xl">ğŸ“Š</span>
        </div>
        <h1 class="text-4xl font-black mb-4 tracking-tight bg-clip-text text-transparent bg-gradient-to-br from-white to-blue-400">åº“å­˜æ§åˆ¶åŸç†æµ‹è¯•å®è®­</h1>
        <p class="text-slate-400 mb-10 text-sm leading-relaxed">Intelligence Inventory Control System v2.0</p>
        
        <div class="grid grid-cols-2 gap-4 mb-10 text-left">
            <div class="p-4 rounded-2xl bg-white/5 border border-white/5">
                <div class="text-red-400 font-bold mb-1">â† å‘å·¦æŒ¥æ‰‹</div>
                <div class="text-xs text-slate-500">åˆ¤å®šå‘½é¢˜ä¸ºâ€œé”™è¯¯â€</div>
            </div>
            <div class="p-4 rounded-2xl bg-white/5 border border-white/5">
                <div class="text-green-400 font-bold mb-1">å‘å³æŒ¥æ‰‹ â†’</div>
                <div class="text-xs text-slate-500">åˆ¤å®šå‘½é¢˜ä¸ºâ€œæ­£ç¡®â€</div>
            </div>
        </div>

        <button onclick="initGame()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-5 rounded-2xl font-black text-lg transition-all btn-glow">
            è¿›å…¥å®è®­ç©ºé—´
        </button>
    </div>

    <div id="loading" class="hidden text-center z-50">
        <div class="relative w-16 h-16 mx-auto mb-6">
            <div class="absolute inset-0 border-4 border-blue-500/20 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-blue-500 rounded-full animate-spin"></div>
        </div>
        <p class="text-blue-400 font-mono text-xs tracking-[0.3em]">SYNCHRONIZING SYSTEM...</p>
    </div>

    <div id="game-ui" class="hidden relative z-20 flex flex-col items-center w-full max-w-2xl px-6">
        <div id="progress-tag" class="px-4 py-1 rounded-full bg-blue-500/10 border border-blue-500/30 text-blue-400 font-mono text-[10px] mb-8 tracking-widest uppercase">Task Sequence // 01</div>
        <div id="card" class="glass p-12 rounded-[2.5rem] text-center w-full relative group">
            <div class="absolute -top-4 -left-4 w-8 h-8 border-t-2 border-l-2 border-blue-500/50"></div>
            <div class="absolute -bottom-4 -right-4 w-8 h-8 border-b-2 border-r-2 border-blue-500/50"></div>
            <p id="q-text" class="text-2xl font-bold min-h-[160px] flex items-center justify-center leading-relaxed px-6 text-white/90 italic"></p>
            <div class="indicator-bar w-0" id="decision-bar"></div>
        </div>
        <div class="mt-12 flex gap-4">
             <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
             <div class="text-slate-500 text-[10px] font-bold tracking-[0.4em] uppercase">Visual Interaction Active</div>
        </div>
    </div>

    <div id="result-hub" class="hidden relative z-30 w-full max-w-4xl px-6 text-center">
        <h2 class="text-5xl font-black mb-12 tracking-tighter">æµ‹è¯„åˆ†æå°±ç»ª</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div onclick="showAnalysis()" class="glass p-10 rounded-[3rem] cursor-pointer group hover:bg-white/5 transition-all">
                <div class="w-16 h-16 bg-blue-500/10 rounded-2xl flex items-center justify-center text-3xl mb-6 mx-auto group-hover:scale-110 transition">ğŸ“‰</div>
                <h3 class="text-2xl font-bold mb-4">å­¦æƒ…è¯Šæ–­æŠ¥å‘Š</h3>
                <p class="text-slate-500 text-sm leading-relaxed">å¤šç»´åº¦è§£æåº“å­˜æ§åˆ¶é€»è¾‘è¯¯åŒº<br>ç²¾å‡†å®šä½çŸ¥è¯†ç‚¹è–„å¼±é¡¹</p>
            </div>
            <div onclick="openDify()" class="glass p-10 rounded-[3rem] cursor-pointer group hover:bg-blue-600/10 border-blue-500/20 transition-all border">
                <div class="w-16 h-16 bg-blue-600/20 rounded-2xl flex items-center justify-center text-3xl mb-6 mx-auto group-hover:scale-110 transition">ğŸ‘©â€ğŸ«</div>
                <h3 class="text-2xl font-bold mb-4 text-blue-400">AI å®è®­å¯¼å¸ˆ</h3>
                <p class="text-slate-500 text-sm leading-relaxed">å¯¹æ¥ Dify çŸ¥è¯†åº“è¿›è¡Œ 1V1 æ·±åº¦å¤ç›˜<br>å³æ—¶è§£ç­”å¤æ‚æ¨¡å‹è®¡ç®—ç–‘é—®</p>
            </div>
        </div>
    </div>

    <div id="analysis-layer" class="hidden fixed inset-0 z-[60] glass flex items-center justify-center p-6">
        <div class="max-w-xl w-full bg-slate-900/90 p-10 rounded-[3rem] shadow-2xl relative border border-white/10">
            <button onclick="document.getElementById('analysis-layer').classList.add('hidden')" class="absolute top-8 right-8 text-slate-500 hover:text-white text-4xl font-light">&times;</button>
            <h3 class="text-2xl font-black mb-8 text-blue-400 uppercase tracking-widest">Diagnostic Report</h3>
            <div id="diagnosis-content" class="space-y-4 mb-10"></div>
            <button onclick="openDify()" class="w-full py-5 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl font-bold btn-glow">è”ç³»å¯¼å¸ˆè¿›è¡Œä¸“é¡¹æå‡</button>
        </div>
    </div>

    <script>
        const questions = [
            { text: "å®‰å…¨åº“å­˜è¶Šå¤§ï¼Œæå‰æœŸæ³¢åŠ¨æ€§è¶Šå¤§ï¼Œå®‰å…¨åº“å­˜æ°´å¹³å°±è¶Šä½ï¼Ÿ", ans: false, tag: "æ³¢åŠ¨ä¸åº“å­˜ç›¸å…³æ€§" },
            { text: "å®‰å…¨åº“å­˜æ˜¯åº”å¯¹å®é™…éœ€æ±‚è¶…å‡ºé¢„æœŸéœ€æ±‚çš„ä¸ç¡®å®šæ€§çš„é‡è¦æ‰‹æ®µï¼Ÿ", ans: true, tag: "åº“å­˜æ§åˆ¶åŸºæœ¬å®šä¹‰" },
            { text: "å¦‚æœè¦æé«˜å®¢æˆ·æœåŠ¡æ°´å¹³ï¼Œåº“å­˜æ€»æˆæœ¬å¿…ç„¶ä¼šéšä¹‹å¢åŠ ï¼Ÿ", ans: false, tag: "æœåŠ¡æ°´å¹³ä¸æˆæœ¬æƒè¡¡" },
            { text: "è®¢å•æ»¡è¶³ç‡æŒ‡çš„æ˜¯ä¸€ä¸ªè¡¥è´§å‘¨æœŸå†…ä¸å‘ç”Ÿç¼ºè´§çš„æ¦‚ç‡ï¼Ÿ", ans: false, tag: "ç»©æ•ˆæŒ‡æ ‡æ¦‚å¿µè¾¨æ" },
            { text: "åº“å­˜æ§åˆ¶ç›®æ ‡åŒ…æ‹¬æé«˜å®¢æˆ·æœåŠ¡æ°´å¹³å’Œé™ä½åº“å­˜æ€»æˆæœ¬ï¼Ÿ", ans: true, tag: "åº“å­˜ç®¡ç†æ ¸å¿ƒç›®æ ‡" }
        ];

        let idx = 0, wrongs = [], canSwipe = true, currentX = 0, targetX = 0, holdCounter = 0;
        let particles = [];
        const canvas = document.getElementById('particle-canvas');
        const ctx = canvas.getContext('2d');

        // åˆå§‹åŒ–ç”»å¸ƒ
        window.onresize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
        window.onresize();

        // ç²’å­ç³»ç»Ÿ
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.size = Math.random() * 4 + 2;
                this.speedX = (Math.random() - 0.5) * 5;
                this.speedY = (Math.random() - 0.5) * 5;
                this.color = color;
                this.life = 1;
            }
            update() {
                this.x += this.speedX; this.y += this.speedY;
                this.life -= 0.02;
            }
            draw() {
                ctx.fillStyle = this.color;
                ctx.globalAlpha = this.life;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2); ctx.fill();
            }
        }

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles = particles.filter(p => p.life > 0);
            particles.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animate);
        }
        animate();

        // éŸ³æ•ˆå¼•æ“
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }

        function initGame() {
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');
            startCamera();
        }

        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1 });
        
        hands.onResults(results => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0][9]; // ä¸­æŒ‡æ ¹éƒ¨
                const x = (1 - lm.x) * canvas.width;
                const y = lm.y * canvas.height;
                
                // ç²’å­è·Ÿéš
                if (canSwipe) {
                    for(let i=0; i<3; i++) particles.push(new Particle(x, y, '#3b82f6'));
                }

                if (canSwipe && idx < questions.length) targetX = (lm.x - 0.5) * -1000;
            } else { targetX = 0; }

            currentX += (targetX - currentX) * 0.15;
            const bg = document.getElementById('bg-overlay');
            const card = document.getElementById('card');
            const bar = document.getElementById('decision-bar');

            if (canSwipe && idx < questions.length) {
                card.style.transform = `translateX(${currentX}px) rotate(${currentX/25}deg)`;
                
                if (currentX > 80) {
                    bg.style.background = `radial-gradient(circle at right, rgba(16, 185, 129, 0.4), transparent 70%)`;
                } else if (currentX < -80) {
                    bg.style.background = `radial-gradient(circle at left, rgba(239, 68, 68, 0.4), transparent 70%)`;
                } else {
                    bg.style.background = "transparent";
                }

                if (Math.abs(currentX) > 160) {
                    if (holdCounter === 0) playTone(400, 'sine', 0.1);
                    holdCounter++;
                    bar.style.width = (holdCounter / 22 * 100) + "%";
                    bar.style.background = currentX > 0 ? "#10b981" : "#ef4444";
                    bar.style.color = currentX > 0 ? "#10b981" : "#ef4444";
                    if (holdCounter >= 22) confirmChoice(currentX > 0);
                } else {
                    holdCounter = 0; bar.style.width = "0%";
                }
            }
        });

        function confirmChoice(choice) {
            canSwipe = false;
            const isCorrect = choice === questions[idx].ans;
            if (!isCorrect) wrongs.push(questions[idx].tag);
            isCorrect ? playTone(800, 'triangle', 0.3) : playTone(200, 'sawtooth', 0.3);
            
            document.getElementById('card').style.transform = `translateX(${choice ? 1500 : -1500}px) scale(0.2) rotate(45deg)`;
            document.getElementById('card').style.opacity = "0";
            document.getElementById('bg-overlay').style.background = "transparent";
            
            setTimeout(() => {
                idx++;
                if (idx < questions.length) resetCard(); else showHub();
            }, 600);
        }

        function resetCard() {
            document.getElementById('q-text').innerText = questions[idx].text;
            document.getElementById('progress-tag').innerText = `Task Sequence // 0${idx + 1}`;
            targetX = currentX = holdCounter = 0;
            const card = document.getElementById('card');
            card.style.transition = "none"; card.style.transform = "translateX(0) scale(1)"; card.style.opacity = "1";
            setTimeout(() => { canSwipe = true; card.style.transition = "transform 0.1s ease-out, opacity 0.4s"; }, 100);
        }

        function showHub() {
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('result-hub').classList.remove('hidden');
        }

        function showAnalysis() {
            const list = document.getElementById('diagnosis-content');
            const unique = [...new Set(wrongs)];
            if (unique.length === 0) {
                list.innerHTML = "<div class='p-8 rounded-3xl bg-green-500/10 border border-green-500/30 text-green-400 text-center font-bold'>æµ‹è¯„ç»“æœï¼šå®Œç¾ã€‚æ‚¨å·²å®Œå…¨æŒæ¡æœ¬èŠ‚å®è®­çš„åº“å­˜æ§åˆ¶æ ¸å¿ƒé€»è¾‘ã€‚</div>";
            } else {
                list.innerHTML = unique.map(tag => `<div class='bg-white/5 p-6 rounded-[2rem] border-l-4 border-blue-500'><h4 class='text-white font-bold mb-1'>${tag}</h4><p class='text-xs text-slate-500 uppercase tracking-tighter'>Review Required / è¯·å¤æ ¸é€»è¾‘æ¨¡å‹</p></div>`).join("");
            }
            document.getElementById('analysis-layer').classList.remove('hidden');
        }

        function openDify() {
            if(window.difyChatbotConfig) {
                const bubbleBtn = document.getElementById('dify-chatbot-bubble-button');
                if (bubbleBtn) bubbleBtn.click();
            } else {
                alert("æ­£åœ¨è°ƒå– Dify å¯¼å¸ˆ...");
            }
        }

        function startCamera() {
            const cam = new Camera(document.getElementById('video-preview'), {
                onFrame: async () => { await hands.send({image: document.getElementById('video-preview')}); },
                width: 640, height: 480
            });
            cam.start().then(() => {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('game-ui').classList.remove('hidden');
                document.getElementById('q-text').innerText = questions[0].text;
            });
        }
    </script>

    <script>
     window.difyChatbotConfig = { token: 'dLcIrIy1AkVHupEu', baseUrl: 'http://exper-api.cfnet.org.cn' }
    </script>
    <script src="https://exper-api.cfnet.org.cn/embed.min.js" id="dLcIrIy1AkVHupEu" defer></script>
</body>
</html>
