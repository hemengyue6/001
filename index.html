<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>库存控制原理测试实训</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

  <style>
    :root {
      --accent-blue: #3b82f6;
      --accent-green: #10b981;
      --accent-red: #ef4444;
    }

    body {
      background: #020617;
      color: #f8fafc;
      overflow: hidden;
      font-family: 'PingFang SC', sans-serif;
    }

    #tech-bg {
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(to right, rgba(59,130,246,.05) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(59,130,246,.05) 1px, transparent 1px);
      background-size: 40px 40px;
      mask-image: radial-gradient(circle at center, black, transparent 80%);
      z-index: 0;
    }

    #video-preview {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 160px;
      border-radius: 16px;
      border: 2px solid rgba(59,130,246,.3);
      transform: scaleX(-1);
      z-index: 100;
    }

    .glass {
      background: rgba(15,23,42,.6);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,.08);
    }

    #bg-overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      opacity: .35;
    }

    #particle-canvas {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 50;
    }

    .indicator-bar {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 6px;
      border-radius: 0 0 2rem 2rem;
    }

    /* 强制 Dify 层级 */
    #dify-chatbot-bubble-button,
    #dify-chatbot-bubble-window {
      z-index: 99999 !important;
    }
  </style>
</head>

<body class="flex items-center justify-center min-h-screen">

<div id="tech-bg"></div>
<div id="bg-overlay"></div>
<canvas id="particle-canvas"></canvas>
<video id="video-preview" autoplay playsinline></video>

<!-- 开始界面 -->
<div id="start-screen" class="relative z-50 glass p-10 rounded-[2.5rem] text-center max-w-xl">
  <h1 class="text-4xl font-black mb-6">库存控制原理测试实训</h1>
  <button onclick="initGame()" class="w-full bg-blue-600 py-5 rounded-2xl font-bold">
    进入实训空间
  </button>
</div>

<!-- 加载 -->
<div id="loading" class="hidden z-50 text-center">
  <p class="text-blue-400">系统初始化中...</p>
</div>

<!-- 游戏 UI -->
<div id="game-ui" class="hidden z-20 w-full max-w-2xl px-6 text-center">
  <div id="card" class="glass p-12 rounded-[2.5rem] relative">
    <p id="q-text" class="text-2xl font-bold min-h-[160px] flex items-center justify-center"></p>
    <div id="decision-bar" class="indicator-bar w-0"></div>
  </div>
</div>

<!-- 结果 -->
<div id="result-hub" class="hidden z-30 text-center max-w-4xl">
  <h2 class="text-4xl font-black mb-10">测评完成</h2>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <div onclick="showAnalysis()" class="glass p-10 rounded-[3rem] cursor-pointer">
      <h3 class="text-xl font-bold">学情诊断报告</h3>
    </div>

    <div onclick="openDify()" class="glass p-10 rounded-[3rem] cursor-pointer border border-blue-500/30">
      <h3 class="text-xl font-bold text-blue-400">AI 实训导师</h3>
      <p class="text-xs text-slate-400 mt-2">点击右下角 AI 图标</p>
    </div>
  </div>
</div>

<!-- 分析层 -->
<div id="analysis-layer" class="hidden fixed inset-0 z-[60] glass flex items-center justify-center">
  <div class="bg-slate-900 p-10 rounded-[3rem] max-w-xl w-full">
    <button onclick="closeAnalysis()" class="absolute top-6 right-6 text-3xl">&times;</button>
    <div id="diagnosis-content"></div>
  </div>
</div>

<script>
/* ===== 题库 ===== */
const questions = [
  { text: "安全库存是应对需求不确定性的手段？", ans: true, tag: "安全库存定义" },
  { text: "服务水平越高，库存成本一定越高？", ans: false, tag: "成本权衡" }
];

let idx = 0;
let wrongs = [];
let canSwipe = true;
let currentX = 0;
let targetX = 0;
let holdCounter = 0;

/* ===== 摄像头 ===== */
function initGame() {
  startCamera();
  document.getElementById('start-screen').classList.add('hidden');
  document.getElementById('loading').classList.remove('hidden');
}

const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({ maxNumHands: 1 });

hands.onResults(res => {
  if (!canSwipe || !res.multiHandLandmarks) return;
  const lm = res.multiHandLandmarks[0][9];
  targetX = (lm.x - .5) * -800;
  currentX += (targetX - currentX) * .15;

  const card = document.getElementById('card');
  card.style.transform = `translateX(${currentX}px) rotate(${currentX/25}deg)`;

  if (Math.abs(currentX) > 160) {
    holdCounter++;
    if (holdCounter > 20) confirmChoice(currentX > 0);
  } else {
    holdCounter = 0;
  }
});

function confirmChoice(choice) {
  canSwipe = false;
  if (choice !== questions[idx].ans) wrongs.push(questions[idx].tag);
  idx++;

  setTimeout(() => {
    if (idx < questions.length) {
      resetCard();
    } else {
      document.getElementById('game-ui').classList.add('hidden');
      document.getElementById('result-hub').classList.remove('hidden');
    }
  }, 500);
}

function resetCard() {
  currentX = targetX = holdCounter = 0;
  canSwipe = true;
  document.getElementById('q-text').innerText = questions[idx].text;
}

function startCamera() {
  const cam = new Camera(document.getElementById('video-preview'), {
    onFrame: async () => {
      await hands.send({ image: document.getElementById('video-preview') });
    }
  });
  cam.start().then(() => {
    document.getElementById('loading').classList.add('hidden');
    document.getElementById('game-ui').classList.remove('hidden');
    document.getElementById('q-text').innerText = questions[0].text;
  });
}

/* ===== 诊断 ===== */
function showAnalysis() {
  document.getElementById('analysis-layer').classList.remove('hidden');
}

function closeAnalysis() {
  document.getElementById('analysis-layer').classList.add('hidden');
}

/* ===== 打开 Dify（安全方案） ===== */
function openDify() {
  const btn = document.getElementById('dify-chatbot-bubble-button');
  if (btn) btn.click();
  else alert("AI 导师正在加载，请稍候");
}
</script>

<!-- ===== Dify Embed（官方推荐写法）===== -->
<script>
  window.difyChatbotConfig = {
    token: '【你的 Dify Token】',
    baseUrl: 'https://exper-api.cfnet.org.cn'
  };
</script>

<script
  src="https://exper-api.cfnet.org.cn/embed.min.js"
  id="【你的 Dify Token】">
</script>

</body>
</html>
